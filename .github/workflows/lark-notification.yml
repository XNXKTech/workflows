name: Notification

on:
  workflow_call:
    inputs:
      stage:
        required: true
        description: The stage of the workflow.
        default: "Staging"
        type: string
    secrets:
      CI_PAT:
        required: false
      LARK_WEBHOOK_URL:
        required: true

jobs:
  notification:
    name: Lark

    runs-on: ubuntu-latest

    permissions: read-all

    steps:
      - name: Split Version or Branch
        uses: jungwinter/split@v2
        id: split
        with:
          separator: '/'
          msg: ${{ github.ref }}

      - name: Checkout ${{ steps.split.outputs._2 }}
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event_name == 'pull_request' && github.ref || steps.split.outputs._2 }}

      - name: Set env
        id: set-env
        run: |
          echo ::set-output name=color::${{ inputs.stage == 'PR Review' && 'orange' || 'green' }}
          echo ::set-output name=changelog::$(git log -1 --pretty=format:"%s")
          echo ::set-output name=message::${{ contains(github.repository, 'web') && 'ç‰ˆæœ¬å·²æ¨é€è‡³ TCBã€CDN èŠ‚ç‚¹ï¼ŒCDN èŠ‚ç‚¹å¼€å§‹æ»šåŠ¨æ›´æ–°ï¼Œé¢„è®¡å‡ åˆ†é’Ÿåç”Ÿæ•ˆã€‚' || 'æœåŠ¡å¼€å§‹æ»šåŠ¨æ›´æ–°ï¼Œé¢„è®¡å‡ åˆ†é’Ÿåç”Ÿæ•ˆã€‚' }}

      - name: Lark Notification
        run: |
          curl '${{ secrets.LARK_WEBHOOK_URL }}' \
             -H 'Content-Type: application/json' \
              -d '
              {
                "msg_type": "interactive",
                "card": {
                  "config": {
                    "wide_screen_mode": true
                },
                "header": {
                  "template": "${{ steps.set-env.outputs.color }}",
                  "title": {
                    "content": "âœ…  ${{inputs.stage}} Deployment for ${{ github.repository }} ready!",
                    "tag": "plain_text"
                  }
                },
                "elements": [
                  {
                    "fields": [
                      {
                        "is_short": true,
                        "text": {
                          "content": "**ğŸ·ï¸  Versionï¼š**\n${{ steps.split.outputs._2 }}",
                          "tag": "lark_md"
                        }
                      },
                      {
                        "is_short": true,
                        "text": {
                          "content": "**ğŸš§  Stageï¼š**\n[${{inputs.stage}}](https://github.com/${{ github.repository }}/deployments/activity_log?environment=${{inputs.stage}})",
                          "tag": "lark_md"
                        }
                      }
                    ],
                    "tag": "div"
                  },
                  {
                    "fields": [
                      {
                        "is_short": true,
                        "text": {
                          "content": "**ğŸ”¨  Latest commitï¼š**\n[${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})",
                          "tag": "lark_md"
                        }
                      },
                      {
                        "is_short": true,
                        "text": {
                          "content": "**ğŸ”  Latest deploy logï¼š**\n[${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})",
                          "tag": "lark_md"
                        }
                      }
                    ],
                    "tag": "div"
                  },
                  {
                    "tag": "hr"
                  },
                  {
                    "tag": "markdown",
                    "content": "**${{ steps.set-env.outputs.message }}**\n\næœ¬æ¬¡ä¸»è¦å˜æ›´å†…å®¹å¦‚ä¸‹ï¼š\n\n${{ steps.set-env.outputs.changelog }}"
                  }
                ]
               }
              }'
